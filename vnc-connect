#!/bin/bash

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get VNC password from API
RESPONSE=$(curl -s http://dojo.localhost/pwncollege_api/v1/workspace/vnc_url \
  -H "Cookie: $(cat ~/.dojo_session 2>/dev/null || echo '')")

PASSWORD=$(echo "$RESPONSE" | jq -r '.password // empty')
SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')

if [ "$SUCCESS" != "true" ] || [ -z "$PASSWORD" ]; then
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${RED}âœ— Failed to get VNC password!${NC}"
  echo -e "${YELLOW}âš  Your session cookie is invalid or expired.${NC}"
  echo -e "${YELLOW}âš  Please update ~/.dojo_session with your current session cookie.${NC}"
  echo -e ""
  echo -e "Steps:"
  echo -e "  1. Open browser dev tools (F12)"
  echo -e "  2. Go to Application/Storage â†’ Cookies"
  echo -e "  3. Copy the 'session' cookie value"
  echo -e "  4. Run: ${GREEN}echo 'session=YOUR_COOKIE_VALUE' > ~/.dojo_session${NC}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  exit 1
else
  echo -e "${GREEN}âœ“ Got VNC password: $PASSWORD${NC}"
fi

echo -e "${GREEN}Starting VNC connection loop...${NC}"
echo -e "${YELLOW}Switch challenges freely - VNC will auto-reconnect!${NC}"
echo ""

# Start keepalive background process
(
  while true; do
    sleep 3600  # Every 1 hour
    curl -s http://dojo.localhost/pwncollege_api/v1/workspace \
      -H "Cookie: $(cat ~/.dojo_session)" > /dev/null 2>&1
  done
) &
KEEPALIVE_PID=$!

while true; do
  # Check if workspace is active
  WORKSPACE_STATUS=$(curl -s http://dojo.localhost/pwncollege_api/v1/workspace \
    -H "Cookie: $(cat ~/.dojo_session)" \
    | jq -r '.active // false')

  if [ "$WORKSPACE_STATUS" != "true" ]; then
    echo -e "${YELLOW}â³ Waiting for workspace to start...${NC}"
    sleep 3
    continue
  fi

  # Start desktop service (this is idempotent - safe to call multiple times)
  echo -e "${YELLOW}ðŸ–¥ï¸  Starting desktop service...${NC}"
  curl -s http://dojo.localhost/pwncollege_api/v1/workspace?service=desktop \
    -H "Cookie: $(cat ~/.dojo_session)" > /dev/null

  # Wait a moment for VNC to start
  sleep 2

  # Create a temporary password file
  PASS_FILE=$(mktemp)
  echo "$PASSWORD" | vncpasswd -f > "$PASS_FILE" 2>/dev/null

  echo -e "${GREEN}ðŸ”Œ Connecting to VNC...${NC}"

  vncviewer \
    -shared \
    -ViewOnly=0 \
    -DotWhenNoCursor=0 \
    -AcceptClipboard=1 \
    -SendClipboard=1 \
    -SetPrimary=1 \
    -SendPrimary=1 \
    -ReconnectOnError=1 \
    -passwd "$PASS_FILE" \
    localhost:5900

  EXIT_CODE=$?
  rm -f "$PASS_FILE"

  # Don't exit on any exit code - always reconnect unless interrupted (Ctrl+C)
  echo -e "${YELLOW}ðŸ”„ Connection ended (exit code: $EXIT_CODE), reconnecting in 3 seconds...${NC}"
  sleep 3
done

# Cleanup keepalive on exit
kill $KEEPALIVE_PID 2>/dev/null
